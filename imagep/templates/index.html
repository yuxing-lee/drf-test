<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Image Process</title>
        <style>
            img {
                height: 10rem;
            }
            .image-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-evenly;
            }
        </style>
    </head>

    <body>
        {% load static %}
        <form id="upload-image">
            {% csrf_token %}
            <input type="file" name="image_url" />
            <button type="submit">Upload</button>
        </form>
        <div id="image-container" class="image-container"></div>
    </body>

    <script>
        let root = {};
        let counter = 1;

        let uploadImage = async (event) => {
            event.preventDefault();
            const form_data = new FormData(event.target);
            let response = await fetch("api/image-management/", {
                method: "POST",
                body: form_data,
            });
            let data = await response.json();
            /* Append to container */
            let image_container = document.getElementById("image-container");
            let image = await generateImage(0, "origin-image", data["image_url"]);
            image_container.appendChild(image);
            root = {
                id: 0,
                image_url: data["image_url"],
                function: "",
                params: {},
                changed: false,
                child: []
            }
        };

        let addImageChild = async (event) => {
            let parent_id = parseInt(event.target.name.split("-")[1]);
            // generate node data
            let data = {
                id: counter,
                image_url: "",
                function: document.getElementById(`function-${parent_id}`).value,
                params: {},
                changed: true,
                child: []
            }
            let node = await findImageChild(root, parent_id);
            node["child"].push(data);
            // Append to container
            let image_container = document.getElementById("image-container");
            let image = await generateImage(counter, "name", "url");
            image_container.appendChild(image);
            counter++;
        };

        let findImageChild = async (node, parent_id) => {
            if (node["id"] == parent_id) {
                return node;
            } else if (node["child"].length == 0) {
                return null;
            }
            for (let child of node["child"]) {
                if (child["id"] == parent_id) {
                    return child;
                }
                let result = await findImageChild(child, parent_id);
                if (result) {
                    return result;
                }
            }
        };

        let generateImage = async (id, image_name, image_url) => {
            let div = document.createElement("div");
            div.className = "image";
            let img = document.createElement("img");
            img.id = image_name;
            img.alt = image_name;
            img.src = image_url;
            let button = document.createElement("button");
            button.name = `btn-${id}`
            button.innerText = "新增";
            button.addEventListener("click", addImageChild);
            div.appendChild(img);
            div.appendChild(generateFunctionSelector(id));
            div.appendChild(button);
            return div;
        };

        let generateFunctionSelector = (id) => {
            let select = document.createElement("select");
            select.id = `function-${id}`;
            select.appendChild(generateFunctionOption("灰階", "gray"));
            select.appendChild(generateFunctionOption("二值化", "binary"));
            select.appendChild(generateFunctionOption("反向", "reverse"));
            return select;
        };

        let generateFunctionOption = (text, value) => {
            let option = document.createElement("option");
            option.text = text;
            option.value = value;
            return option;
        };

        document
            .getElementById("upload-image")
            .addEventListener("submit", uploadImage);
    </script>
</html>
